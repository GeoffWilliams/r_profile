<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Puppet Class: r_profile::cloud::azure_platform
  
    &mdash; Documentation by YARD 0.9.16
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "puppet_classes::r_profile::cloud::azure_platform";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../puppet_class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (r)</a> &raquo;
    <span class='title'><span class='object_link'>Puppet Classes</span></span>
     &raquo; 
    <span class="title">r_profile::cloud::azure_platform</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="puppet_class_list_link"
        href="../puppet_class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Puppet Class: r_profile::cloud::azure_platform</h1>
<div class="box_info">
  
  
  <dl>
    <dt>Defined in:</dt>
    <dd>
      manifests/cloud/azure_platform.pp
    </dd>
  </dl>
</div>

<h2>Overview</h2>
<div class="docstring">
  <div class="discussion">
    <p>R_profile::Cloud::Azure_platform</p>

<p>Setup the dependencies for the puppetlabs/azure forge module</p>

<p>The forge module uses a locally installed copy of the Azure library in order
to talk to the Azure Cloud.  There are presently two versions of this library:</p>

<ul>
<li><code>azure</code> command via the Azure xplat-cli (older, written in nodejs)</li>
<li><code>az</code> command via Azure CLI 2.0 (newer, written in python)</li>
</ul>

<p>v1.x of forge module uses the xplat-cli and that is what this profile sets up
for you.</p>

<p>puppet module install puppet-nodejs --version 2.3.0</p>

  </div>
</div>


<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>subscriptions</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Hash of subscriptions with the format:</p>

<pre class="code ruby"><code class="ruby">  <span class='id identifier rubyid_subscription_name'>subscription_name</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='id identifier rubyid_subscription_id'>subscription_id</span>           <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>the_subscription_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_tenant_id'>tenant_id</span>                 <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>the_tenant_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_client_id'>client_id</span>                 <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>the_client_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_client_secret'>client_secret</span>             <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>the_client_secret</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_user'>user</span>                      <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>local linux user to run as</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_homedir'>homedir</span>                   <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>home dir to install puppet agent</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_puppet_master_fqdn'>puppet_master_fqdn</span>        <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fqdn.of.puppetmaster</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='id identifier rubyid_run_puppet_ssh_public_key'>run_puppet_ssh_public_key</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>your public key...</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
  <span class='rbrace'>}</span>
</code></pre>

<ul>
<li>subscription_id The subsciption ID to provision ID to work with,
obtainedfrom billing page in azure portal</li>
<li>tenant_id The active directory tennant ID to work with, see
<a href="https://stackoverflow.com/a/41028320/3441106">https://stackoverflow.com/a/41028320/3441106</a></li>
<li>client_id This is the equivalent of a username and involves registering
an application in the Azure AD instance.  Once registered, the field to use
here is <code>application_id</code>.  We don&#39;t use <code>object_id</code> at all.  Important:
Once the user has been created, it needs to be given RBAC access to the
Azure API which is done through the billing -&gt; subscriptions menu
@see <a href="https://docs.bmc.com/docs/cloudlifecyclemanagement/46/setting-up-a-tenant-id-client-id-and-client-secret-for-azure-resource-manager-provisioning-669202145.html">https://docs.bmc.com/docs/cloudlifecyclemanagement/46/setting-up-a-tenant-id-client-id-and-client-secret-for-azure-resource-manager-provisioning-669202145.html</a></li>
<li>client_secret This is the equivalent of a password for the above user
and can be found by following the above tutorial</li>
<li>user local user who will run this puppet agent</li>
<li>homedir of this user (guess at /home/$user if absent)</li>
<li>puppet_master_fqdn Address of puppet master to connect this agent to</li>
<li>run_puppet_ssh_public_key If present, configure SSH to allow connections
using this key to run the puppet agent -t command automatically</li>
</ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>azure_gem_version</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;0.7.9&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Specify the version of the <code>azure</code> gem to use to talk
to the azure API - useful if you need to use a newer version of the
<code>puppetlabs-azure</code> module</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>azure_mgmt_gem_version</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;0.3.1&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Specify the version of the <code>azure-mgmt-*</code> gems to
use to talk to the azure API - useful if you need to use a newer version of
the <code>puppetlabs-azure</code> module</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>run_puppet_command</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;/opt/puppetlabs/puppet/bin/puppet agent -t&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>How to run puppet agent (only this command will be allowed
via SSH)</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://github.com/Azure/azure-xplat-cli" target="_parent" title="https://github.com/Azure/azure-xplat-cli">https://github.com/Azure/azure-xplat-cli</a></li>
    
  </ul>

</div><div class="method_details_list">
  <table class="source_code">
    <tr>
      <td>
        <pre class="lines">


55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</pre>
      </td>
      <td>
        <pre class="code"><span class="info file"># File 'manifests/cloud/azure_platform.pp', line 55</span>

class r_profile::cloud::azure_platform(
    Hash    $subscriptions          = {},
    String  $azure_gem_version      = &quot;0.7.9&quot;,
    String  $azure_mgmt_gem_version = &quot;0.3.1&quot;,
    String  $run_puppet_command     = &quot;/opt/puppetlabs/puppet/bin/puppet agent -t&quot;,
) {

  # only for root agents
  if $facts[&#39;identity&#39;][&#39;privileged&#39;] {
    $challenge_password = hiera(&#39;r_profile::puppet::master::autosign::secret&#39;,undef)


    # The gems need a bunch of development libraries to compile properly so use
    # the yum group install command
    package { &quot;Development Tools&quot;:
      ensure   =&gt; present,
      provider =&gt; yum_group,
    }

    include r_profile::nodejs


    ensure_packages(
      [
        &#39;gcc&#39;,
        &#39;libffi-devel&#39;,
        &#39;python-devel&#39;,
        &#39;openssl-devel&#39;,
        &#39;perl-Digest-SHA&#39;
      ],
      {
        ensure =&gt; present
      }
    )

    package { &#39;azure-cli&#39;:
      ensure   =&gt; &#39;present&#39;,
      provider =&gt; &#39;npm&#39;,
    }


    # Azure module very picky about what rubygems to use so we pin exact versions.
    # Using a gem that is too new will give ruby errors like this:
    #   Error: Could not run: Puppet detected a problem with the information
    #   returned from Azure when accessing azure_vm. The specific error was:
    #   undefined method `value&#39; for #&lt;Array:0x000000057af3c8&gt;
    package { &quot;hocon&quot;:
      ensure   =&gt; &quot;1.1.3&quot;,
      provider =&gt; &quot;puppet_gem&quot;,
    }

    package { &quot;retries&quot;:
      ensure   =&gt; &quot;0.0.5&quot;,
      provider =&gt; &quot;puppet_gem&quot;,
    }

    package { &quot;azure&quot;:
      ensure   =&gt; $azure_gem_version,
      provider =&gt; &quot;puppet_gem&quot;,
    }

    package { [ &quot;azure_mgmt_compute&quot;, &quot;azure_mgmt_network&quot;, &quot;azure_mgmt_resources&quot;, &quot;azure_mgmt_storage&quot;]:
      ensure   =&gt; $azure_mgmt_gem_version,
      provider =&gt; &quot;puppet_gem&quot;,
    }



    $subscriptions.each |$certname, $opts| {
      $homedir = pick($opts[&#39;homedir&#39;], &quot;/home/${opts[&#39;user&#39;]}&quot;)
      $puppet_conf_dir = &quot;${homedir}/.puppetlabs/etc/puppet&quot;

      # create a non-root puppet agent for each subscription ID
      puppet_nonroot { $certname:
        puppet_master_fqdn =&gt; $opts[&#39;puppet_master_fqdn&#39;],
        user               =&gt; $opts[&#39;user&#39;],
        homedir            =&gt; $opts[&#39;homedir&#39;],
        challenge_password =&gt; $challenge_password,
      }

      # If all required authentication fields are present, manage the azure.conf
      # file and its content, otherwise leave it alone.  This allows it to be
      # populated by other methods if necessary

      if $opts[&#39;subscription_id&#39;] and $opts[&#39;tenant_id&#39;] and $opts[&#39;client_id&#39;] and $opts[&#39;client_secret&#39;] {

        file { &quot;${puppet_conf_dir}/azure.conf&quot;:
          ensure  =&gt; file,
          owner   =&gt; $opts[&#39;user&#39;],
          group   =&gt; $opts[&#39;group&#39;],
          mode    =&gt; &#39;0600&#39;,
          content =&gt; epp(&quot;${module_name}/cloud/azure/azure.conf.epp&quot;, {
              subscription_id =&gt; $opts[&#39;subscription_id&#39;],
              tenant_id       =&gt; $opts[&#39;tenant_id&#39;],
              client_id       =&gt; $opts[&#39;client_id&#39;],
              client_secret   =&gt; $opts[&#39;client_secret&#39;],
          }),
        }
      }

      # Public key detected, setup SSH to allow running puppet
      if has_key($opts, &quot;run_puppet_ssh_public_key&quot;) {
        $auth = &quot;command=&#39;${run_puppet_command}&#39; ${opts[&#39;run_puppet_ssh_public_key&#39;]}&quot;
        sshkeys::manual { $opts[&#39;user&#39;]:
          home            =&gt; $homedir,
          group           =&gt; $opts[&quot;user&quot;],
          authorized_keys =&gt; $auth,
        }
      }
    }
  }
}</pre>
      </td>
    </tr>
  </table>
</div>
</div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>